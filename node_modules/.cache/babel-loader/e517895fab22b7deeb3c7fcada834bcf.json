{"ast":null,"code":"/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { documentMap } from '../model/collections';\nimport { Document } from '../model/document';\nimport { fail } from '../util/assert';\nimport { DbRemoteDocument } from './indexeddb_schema';\nimport { SimpleDbTransaction } from './simple_db';\n\nvar IndexedDbRemoteDocumentCache =\n/** @class */\nfunction () {\n  function IndexedDbRemoteDocumentCache(serializer) {\n    this.serializer = serializer;\n  }\n\n  IndexedDbRemoteDocumentCache.prototype.addEntry = function (transaction, maybeDocument) {\n    return remoteDocumentsStore(transaction).put(dbKey(maybeDocument.key), this.serializer.toDbRemoteDocument(maybeDocument));\n  };\n\n  IndexedDbRemoteDocumentCache.prototype.removeEntry = function (transaction, documentKey) {\n    return remoteDocumentsStore(transaction).delete(dbKey(documentKey));\n  };\n\n  IndexedDbRemoteDocumentCache.prototype.getEntry = function (transaction, documentKey) {\n    var _this = this;\n\n    return remoteDocumentsStore(transaction).get(dbKey(documentKey)).next(function (dbRemoteDoc) {\n      return dbRemoteDoc ? _this.serializer.fromDbRemoteDocument(dbRemoteDoc) : null;\n    });\n  };\n\n  IndexedDbRemoteDocumentCache.prototype.getDocumentsMatchingQuery = function (transaction, query) {\n    var _this = this;\n\n    var results = documentMap(); // Documents are ordered by key, so we can use a prefix scan to narrow down\n    // the documents we need to match the query against.\n\n    var startKey = query.path.toArray();\n    var range = IDBKeyRange.lowerBound(startKey);\n    return remoteDocumentsStore(transaction).iterate({\n      range: range\n    }, function (key, dbRemoteDoc, control) {\n      var maybeDoc = _this.serializer.fromDbRemoteDocument(dbRemoteDoc);\n\n      if (!query.path.isPrefixOf(maybeDoc.key.path)) {\n        control.done();\n      } else if (maybeDoc instanceof Document && query.matches(maybeDoc)) {\n        results = results.insert(maybeDoc.key, maybeDoc);\n      }\n    }).next(function () {\n      return results;\n    });\n  };\n\n  return IndexedDbRemoteDocumentCache;\n}();\n\nexport { IndexedDbRemoteDocumentCache };\n/**\n * Helper to get a typed SimpleDbStore for the remoteDocuments object store.\n */\n\nfunction remoteDocumentsStore(txn) {\n  if (txn instanceof SimpleDbTransaction) {\n    return txn.store(DbRemoteDocument.store);\n  } else {\n    return fail('Invalid transaction object provided!');\n  }\n}\n\nfunction dbKey(docKey) {\n  return docKey.path.toArray();\n}","map":null,"metadata":{},"sourceType":"module"}