{"ast":null,"code":"/**\n * Copyright 2017 Google Inc.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *   http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { documentMap, maybeDocumentMap } from '../model/collections';\nimport { Document } from '../model/document';\nimport { DocumentKey } from '../model/document_key';\nimport { PersistencePromise } from './persistence_promise';\n\nvar MemoryRemoteDocumentCache =\n/** @class */\nfunction () {\n  function MemoryRemoteDocumentCache() {\n    this.docs = maybeDocumentMap();\n  }\n\n  MemoryRemoteDocumentCache.prototype.addEntry = function (transaction, maybeDocument) {\n    this.docs = this.docs.insert(maybeDocument.key, maybeDocument);\n    return PersistencePromise.resolve();\n  };\n\n  MemoryRemoteDocumentCache.prototype.removeEntry = function (transaction, documentKey) {\n    this.docs = this.docs.remove(documentKey);\n    return PersistencePromise.resolve();\n  };\n\n  MemoryRemoteDocumentCache.prototype.getEntry = function (transaction, documentKey) {\n    return PersistencePromise.resolve(this.docs.get(documentKey));\n  };\n\n  MemoryRemoteDocumentCache.prototype.getDocumentsMatchingQuery = function (transaction, query) {\n    var results = documentMap(); // Documents are ordered by key, so we can use a prefix scan to narrow down\n    // the documents we need to match the query against.\n\n    var prefix = new DocumentKey(query.path.child(''));\n    var iterator = this.docs.getIteratorFrom(prefix);\n\n    while (iterator.hasNext()) {\n      var _a = iterator.getNext(),\n          key = _a.key,\n          maybeDoc = _a.value;\n\n      if (!query.path.isPrefixOf(key.path)) {\n        break;\n      }\n\n      if (maybeDoc instanceof Document && query.matches(maybeDoc)) {\n        results = results.insert(maybeDoc.key, maybeDoc);\n      }\n    }\n\n    return PersistencePromise.resolve(results);\n  };\n\n  return MemoryRemoteDocumentCache;\n}();\n\nexport { MemoryRemoteDocumentCache };","map":null,"metadata":{},"sourceType":"module"}